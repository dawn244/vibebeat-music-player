<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeBeat - Playlists</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Main App -->
    <div id="mainApp">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-music"></i>
                    <span>VibeBeat</span>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="search.html" class="nav-item">
                    <i class="fas fa-search"></i>
                    <span>Search</span>
                </a>
                <a href="library.html" class="nav-item">
                    <i class="fas fa-music"></i>
                    <span>Your Library</span>
                </a>
                <a href="playlists.html" class="nav-item active">
                    <i class="fas fa-list"></i>
                    <span>Playlists</span>
                </a>
                <a href="liked.html" class="nav-item">
                    <i class="fas fa-heart"></i>
                    <span>Liked Songs</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
            
            <div class="sidebar-playlists">
                <div class="playlist-header" style="display:flex;gap:0.5rem;align-items:center;">
                    <button class="create-playlist-btn" id="createPlaylistBtn">
                        <i class="fas fa-plus"></i>
                        <span>Create Playlist</span>
                    </button>
                    <button class="create-playlist-btn" id="uploadSongBtn" title="Upload MP3">
                        <i class="fas fa-upload"></i>
                        <span>Upload Song</span>
                    </button>
                    <input type="file" id="uploadSongInput" accept="audio/mpeg" style="display:none;" />
                </div>
                <div class="playlist-list" id="playlistList">
                    <!-- Playlists will be dynamically added here -->
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="nav-buttons">
                    <button class="nav-btn" id="backBtn" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn" id="forwardBtn" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search playlists...">
                        <button class="search-clear" id="searchClear" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="user-menu">
                    <div class="user-profile" id="userProfile">
                        <img src="https://i.pravatar.cc/40" alt="Profile" id="userAvatar">
                        <span id="userName">User</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <div class="playlists-header">
                    <h1>Your Playlists</h1>
                    <button class="create-playlist-btn" id="createPlaylistMainBtn">
                        <i class="fas fa-plus"></i>
                        New Playlist
                    </button>
                </div>
                
                <div class="playlists-content">
                    <div class="playlists-filters">
                        <button class="filter-btn active" data-filter="all">All Playlists</button>
                        <button class="filter-btn" data-filter="system">System</button>
                        <button class="filter-btn" data-filter="custom">Custom</button>
                        <button class="filter-btn" data-filter="recent">Recently Created</button>
                        <button class="filter-btn" data-filter="popular">Most Played</button>
                    </div>
                    
                    <!-- System Playlists Section -->
                    <div class="playlists-section">
                        <h3>Your Music</h3>
                        <div class="playlists-grid" id="systemPlaylistsGrid">
                            <!-- System playlists will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Custom Playlists Section -->
                    <div class="playlists-section">
                        <h3>Your Playlists</h3>
                        <div class="playlists-grid" id="customPlaylistsGrid">
                            <!-- Custom playlists will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Music Player -->
    <div class="music-player" id="musicPlayer">
        <div class="player-left">
            <div class="track-info">
                <div class="track-image-container">
                    <img src="https://i.scdn.co/image/ab67616d0000b2736dafe7cc3b0811b46c7f6617" alt="Track" id="trackImage" class="track-image">
                    <div class="track-image-placeholder" id="trackImagePlaceholder">
                        <i class="fas fa-music"></i>
                    </div>
                </div>
                <div class="track-details">
                    <h4 id="trackTitle">Select a song</h4>
                    <p id="trackArtist">VibeBeat</p>
                </div>
            </div>
            <button class="like-btn" id="likeBtn">
                <i class="far fa-heart"></i>
            </button>
        </div>

        <div class="player-center">
            <div class="player-controls">
                <button class="control-btn" id="shuffleBtn" title="Shuffle">
                    <i class="fas fa-random"></i>
                </button>
                <button class="control-btn" id="prevBtn" title="Previous">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="control-btn play-btn" id="playBtn" title="Play">
                    <i class="fas fa-play"></i>
                </button>
                <button class="control-btn" id="nextBtn" title="Next">
                    <i class="fas fa-step-forward"></i>
                </button>
                <button class="control-btn" id="repeatBtn" title="Repeat">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
            
            <div class="progress-container">
                <span class="time" id="currentTime">0:00</span>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <span class="time" id="totalTime">0:00</span>
            </div>
        </div>

        <div class="player-right">
            <div class="volume-controls">
                <button class="control-btn" id="volumeBtn" title="Mute">
                    <i class="fas fa-volume-up"></i>
                </button>
                <div class="volume-slider">
                    <input type="range" id="volumeRange" min="0" max="100" value="70">
                </div>
            </div>
            <button class="control-btn" id="queueBtn" title="Queue">
                <i class="fas fa-list"></i>
            </button>
        </div>

        <audio id="audioPlayer" preload="metadata"></audio>
    </div>

    <!-- Modals -->
    <div class="modal" id="createPlaylistModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Playlist</h2>
                <button class="modal-close" id="closePlaylistModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="playlistName">Playlist Name</label>
                    <input type="text" id="playlistName" placeholder="My Playlist" required>
                </div>
                <div class="input-group">
                    <label for="playlistDescription">Description (Optional)</label>
                    <textarea id="playlistDescription" placeholder="Add a description..."></textarea>
                </div>
                <div class="input-group">
                    <label for="playlistImage">Cover Image (Optional)</label>
                    <input type="url" id="playlistImage" placeholder="https://example.com/image.jpg">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelPlaylist">Cancel</button>
                <button class="btn-primary" id="createPlaylist">Create</button>
            </div>
        </div>
    </div>

    <div class="modal" id="playlistDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="playlistDetailsTitle">Playlist Details</h2>
                <button class="modal-close" id="closePlaylistDetailsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="playlist-details-content" id="playlistDetailsContent">
                    <!-- Playlist details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="closePlaylistDetails">Close</button>
                <button class="btn-primary" id="editPlaylist">Edit</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Playlists page specific functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const userData = localStorage.getItem('vibeBeatUser');
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }
            
            // Load user data
            const user = JSON.parse(userData);
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userAvatar').src = user.avatar;
            
            // Initialize music app
            if (typeof MusicApp !== 'undefined') {
                window.app = new MusicApp();
                window.app.start();
            }
            
            // Wire create playlist modal actions
            wireCreatePlaylistModal();

            // Wire upload song
            const uploadBtn = document.getElementById('uploadSongBtn');
            const uploadInput = document.getElementById('uploadSongInput');
            if (uploadBtn && uploadInput) {
                uploadBtn.addEventListener('click', () => uploadInput.click());
                uploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files && e.target.files[0];
                    if (!file) return;
                    try {
                        await uploadSong(file);
                        await loadPlaylists();
                        alert('Upload complete');
                    } catch (err) {
                        console.error('Upload failed', err);
                        alert('Upload failed');
                    } finally {
                        uploadInput.value = '';
                    }
                });
            }

            // Load playlists from backend + system
            loadPlaylists();
            
            // Setup playlist filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterPlaylists(this.dataset.filter);
                });
            });
        });
        
        async function loadPlaylists() {
            const likedSongs = JSON.parse(localStorage.getItem('vibeBeatLikedSongs') || '[]');
            const musicLibrary = getMusicLibrary();

            // Create system playlists (local, informational)
            const systemPlaylists = createSystemPlaylists(likedSongs, musicLibrary);

            // Fetch custom playlists from backend
            let customPlaylists = [];
            try {
                const res = await fetch('http://127.0.0.1:8000/playlists');
                const data = await res.json();
                customPlaylists = data.playlists || [];
            } catch (e) {
                console.error('Failed to fetch playlists from backend', e);
            }

            displaySystemPlaylists(systemPlaylists);
            displayCustomPlaylists(customPlaylists);
        }
        
        function createSystemPlaylists(likedSongs, musicLibrary) {
            const allSongs = Object.values(musicLibrary);
            const currentYear = new Date().getFullYear();
            
            return [
                {
                    id: 'liked',
                    name: 'Liked Songs',
                    description: `${likedSongs.length} songs you've liked`,
                    songs: likedSongs,
                    image: 'https://i.scdn.co/image/ab67616d0000b2736dafe7cc3b0811b46c7f6617',
                    isSystem: true,
                    type: 'liked',
                    createdAt: new Date().toISOString(),
                    playCount: 0,
                    color: '#1ed760'
                },
                {
                    id: 'favorites',
                    name: 'Favorite Songs',
                    description: 'Your most played and loved tracks',
                    songs: getFavoriteSongs(allSongs),
                    image: 'https://i.scdn.co/image/ab67616d0000b27346eb72bcf13c7b82cf67d3f8',
                    isSystem: true,
                    type: 'favorites',
                    createdAt: new Date().toISOString(),
                    playCount: 0,
                    color: '#ff6b6b'
                },
                {
                    id: 'old-songs',
                    name: 'Old Songs',
                    description: 'Classic tracks from previous years',
                    songs: getOldSongs(allSongs, currentYear),
                    image: 'https://i.scdn.co/image/ab67616d0000b273d911c299fbb92c28e9a99217',
                    isSystem: true,
                    type: 'old',
                    createdAt: new Date().toISOString(),
                    playCount: 0,
                    color: '#4ecdc4'
                },
                {
                    id: 'recently-added',
                    name: 'Recently Added',
                    description: 'Songs added to your library recently',
                    songs: getRecentlyAddedSongs(allSongs),
                    image: 'https://i.scdn.co/image/ab67616d0000b273f76b3f8afcd46e3f9ec99438',
                    isSystem: true,
                    type: 'recent',
                    createdAt: new Date().toISOString(),
                    playCount: 0,
                    color: '#45b7d1'
                },
                {
                    id: 'chill-vibes',
                    name: 'Chill Vibes',
                    description: 'Relaxing and ambient music',
                    songs: getChillSongs(allSongs),
                    image: 'https://i.scdn.co/image/ab67616d0000b273a3b73e2d8a5b5b5b5b5b5b5b',
                    isSystem: true,
                    type: 'chill',
                    createdAt: new Date().toISOString(),
                    playCount: 0,
                    color: '#96ceb4'
                },
                {
                    id: 'workout-mix',
                    name: 'Workout Mix',
                    description: 'High-energy songs for your workout',
                    songs: getWorkoutSongs(allSongs),
                    image: 'https://i.scdn.co/image/ab67616d0000b273b3b73e2d8a5b5b5b5b5b5b5b5',
                    isSystem: true,
                    type: 'workout',
                    createdAt: new Date().toISOString(),
                    playCount: 0,
                    color: '#feca57'
                },
                {
                    id: 'party-hits',
                    name: 'Party Hits',
                    description: 'Upbeat songs for any celebration',
                    songs: getPartySongs(allSongs),
                    image: 'https://i.scdn.co/image/ab67616d0000b273c3b73e2d8a5b5b5b5b5b5b5b5',
                    isSystem: true,
                    type: 'party',
                    createdAt: new Date().toISOString(),
                    playCount: 0,
                    color: '#ff9ff3'
                },
                {
                    id: 'study-focus',
                    name: 'Study & Focus',
                    description: 'Instrumental and focus music',
                    songs: getStudySongs(allSongs),
                    image: 'https://i.scdn.co/image/ab67616d0000b273d3b73e2d8a5b5b5b5b5b5b5b5',
                    isSystem: true,
                    type: 'study',
                    createdAt: new Date().toISOString(),
                    playCount: 0,
                    color: '#a8e6cf'
                }
            ];
        }
        
        function getFavoriteSongs(allSongs) {
            // Simulate favorite songs based on play count or user preference
            return allSongs.slice(0, 4);
        }
        
        function getOldSongs(allSongs, currentYear) {
            // Filter songs from previous years
            return allSongs.filter(song => song.year < currentYear - 1);
        }
        
        function getRecentlyAddedSongs(allSongs) {
            // Simulate recently added songs
            return allSongs.slice(0, 6);
        }
        
        function getChillSongs(allSongs) {
            // Filter by genre for chill music
            return allSongs.filter(song => 
                song.genre === 'Ambient' || 
                song.genre === 'Lofi' || 
                song.genre === 'Jazz'
            );
        }
        
        function getWorkoutSongs(allSongs) {
            // Filter high-energy songs
            return allSongs.filter(song => 
                song.genre === 'Electronic' || 
                song.genre === 'Pop' ||
                song.title.toLowerCase().includes('energy')
            );
        }
        
        function getPartySongs(allSongs) {
            // Filter upbeat party songs
            return allSongs.filter(song => 
                song.genre === 'Pop' || 
                song.genre === 'Electronic' ||
                song.title.toLowerCase().includes('party')
            );
        }
        
        function getStudySongs(allSongs) {
            // Filter instrumental and focus music
            return allSongs.filter(song => 
                song.genre === 'Ambient' || 
                song.genre === 'Lofi' ||
                song.title.toLowerCase().includes('chill')
            );
        }
        
        function displaySystemPlaylists(playlists) {
            const grid = document.getElementById('systemPlaylistsGrid');
            grid.innerHTML = playlists.map(playlist => createPlaylistCard(playlist)).join('');
            wirePlaylistPlayButtons();
        }
        
        function displayCustomPlaylists(playlists) {
            const grid = document.getElementById('customPlaylistsGrid');
            
            if (playlists.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-music"></i>
                        <h3>No custom playlists yet</h3>
                        <p>Create your first playlist to get started</p>
                        <button class="btn-primary" onclick="document.getElementById('createPlaylistMainBtn').click()">
                            Create Playlist
                        </button>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = playlists.map(playlist => createPlaylistCard(playlist)).join('');
            wirePlaylistPlayButtons();
        }
        
        function createPlaylistCard(playlist) {
            const songCount = playlist.songs ? playlist.songs.length : 0;
            const createdDate = new Date(playlist.createdAt).toLocaleDateString();
            const isSystem = playlist.isSystem || false;
            const playlistType = playlist.type || 'custom';
            
            return `
                <div class="playlist-card ${isSystem ? 'system-playlist' : 'custom-playlist'}" data-playlist-id="${playlist.id}" data-type="${playlistType}">
                    <div class="playlist-image" style="${isSystem && playlist.color ? `background: linear-gradient(135deg, ${playlist.color}20, ${playlist.color}40);` : ''}">
                        ${isSystem ? `
                            <div class="system-playlist-icon" style="background: ${playlist.color || '#1ed760'};">
                                <i class="fas ${getPlaylistIcon(playlistType)}"></i>
                            </div>
                        ` : `
                            <img src="${playlist.image || 'https://i.scdn.co/image/ab67616d0000b2736dafe7cc3b0811b46c7f6617'}" alt="${playlist.name}">
                        `}
                        <div class="playlist-overlay">
                            <button class="playlist-play-btn" data-playlist-id="${playlist._id || playlist.id}">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    </div>
                    <div class="playlist-info">
                        <h3 class="playlist-name">${playlist.name}</h3>
                        <p class="playlist-description">${playlist.description || `${songCount} songs`}</p>
                        <div class="playlist-meta">
                            ${isSystem ? `
                                <span class="playlist-type">${getPlaylistTypeLabel(playlistType)}</span>
                            ` : `
                                <span class="playlist-date">Created ${createdDate}</span>
                                ${playlist.playCount ? `<span class="playlist-plays">${playlist.playCount} plays</span>` : ''}
                            `}
                        </div>
                    </div>
                    <div class="playlist-actions">
                        <button class="playlist-action-btn" onclick="showPlaylistDetails('${playlist._id || playlist.id}')" title="View Details">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        ${!isSystem ? `
                            <button class="playlist-action-btn" onclick="editPlaylist('${playlist._id || playlist.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="playlist-action-btn" onclick="deletePlaylist('${playlist._id || playlist.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : `
                            <button class="playlist-action-btn" onclick="refreshPlaylist('${playlist.id}')" title="Refresh">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        `}
                    </div>
                </div>
            `;
        }

        function wirePlaylistPlayButtons() {
            document.querySelectorAll('.playlist-play-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const pid = e.currentTarget.dataset.playlistId;
                    try {
                        await fetch(`http://127.0.0.1:8000/queue/from_playlist/${pid}`, { method: 'POST' });
                        // Refresh queue and start playback using global functions from script.js
                        if (typeof loadPlaylist === 'function') {
                            await loadPlaylist();
                            if (typeof playSong === 'function') {
                                playSong(0);
                            }
                        }
                    } catch (err) {
                        console.error('Failed to play playlist', err);
                    }
                });
            });
        }
        
        function getPlaylistIcon(type) {
            const icons = {
                'liked': 'fa-heart',
                'favorites': 'fa-star',
                'old': 'fa-clock',
                'recent': 'fa-plus-circle',
                'chill': 'fa-leaf',
                'workout': 'fa-dumbbell',
                'party': 'fa-music',
                'study': 'fa-book'
            };
            return icons[type] || 'fa-music';
        }
        
        function getPlaylistTypeLabel(type) {
            const labels = {
                'liked': 'Liked Songs',
                'favorites': 'Favorites',
                'old': 'Classics',
                'recent': 'Recent',
                'chill': 'Chill',
                'workout': 'Workout',
                'party': 'Party',
                'study': 'Study'
            };
            return labels[type] || 'Custom';
        }
        
        function filterPlaylists(filter) {
            const playlists = JSON.parse(localStorage.getItem('vibeBeatPlaylists') || '[]');
            const likedSongs = JSON.parse(localStorage.getItem('vibeBeatLikedSongs') || '[]');
            const musicLibrary = getMusicLibrary();
            const systemPlaylists = createSystemPlaylists(likedSongs, musicLibrary);
            
            let filteredSystemPlaylists = [...systemPlaylists];
            let filteredCustomPlaylists = [...playlists];
            
            switch(filter) {
                case 'system':
                    displaySystemPlaylists(filteredSystemPlaylists);
                    document.getElementById('customPlaylistsGrid').innerHTML = '';
                    return;
                case 'custom':
                    displayCustomPlaylists(filteredCustomPlaylists);
                    document.getElementById('systemPlaylistsGrid').innerHTML = '';
                    return;
                case 'recent':
                    filteredCustomPlaylists.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'popular':
                    filteredCustomPlaylists.sort((a, b) => (b.playCount || 0) - (a.playCount || 0));
                    break;
                default:
                    // Show all
                    break;
            }
            
            displaySystemPlaylists(filteredSystemPlaylists);
            displayCustomPlaylists(filteredCustomPlaylists);
        }
        
        function refreshPlaylist(playlistId) {
            // Refresh system playlist content
            const likedSongs = JSON.parse(localStorage.getItem('vibeBeatLikedSongs') || '[]');
            const musicLibrary = getMusicLibrary();
            const systemPlaylists = createSystemPlaylists(likedSongs, musicLibrary);
            const playlist = systemPlaylists.find(p => p.id === playlistId);
            
            if (playlist) {
                // Update the playlist with fresh data
                loadPlaylists();
                alert(`${playlist.name} has been refreshed!`);
            }
        }
        
        async function showPlaylistDetails(playlistId) {
            const modal = document.getElementById('playlistDetailsModal');
            const titleEl = document.getElementById('playlistDetailsTitle');
            const content = document.getElementById('playlistDetailsContent');
            try {
                const [plRes, songsRes] = await Promise.all([
                    fetch(`http://127.0.0.1:8000/playlists/${playlistId}`),
                    fetch('http://127.0.0.1:8000/songs'),
                ]);
                const playlist = await plRes.json();
                const songsData = await songsRes.json();
                const songs = songsData.songs || [];

                titleEl.textContent = playlist.name;

                const currentSongs = playlist.songs || [];
                const currentIds = new Set(currentSongs.map(s => String(s.file_id)));

                const currentListHtml = currentSongs.length ? currentSongs.map(s => `
                    <div class="queue-item">
                        <div class="queue-item-info">
                            <h5>${s.filename}</h5>
                        </div>
                        <button class="playlist-action-btn" data-action="remove" data-file-id="${s.file_id}" data-playlist-id="${playlist._id}"><i class="fas fa-minus"></i></button>
                    </div>
                `).join('') : '<p>No songs in this playlist yet.</p>';

                const addableSongs = songs.filter(s => !currentIds.has(String(s._id)));
                const addListHtml = addableSongs.length ? addableSongs.map(s => `
                    <div class="queue-item">
                        <div class="queue-item-info">
                            <h5>${s.filename}</h5>
                        </div>
                        <button class="playlist-action-btn" data-action="add" data-file-id="${s._id}" data-playlist-id="${playlist._id}"><i class="fas fa-plus"></i></button>
                    </div>
                `).join('') : '<p>All available songs are already in this playlist.</p>';

                content.innerHTML = `
                    <h4>Current Songs</h4>
                    <div>${currentListHtml}</div>
                    <hr style="opacity:.2;margin:1rem 0;" />
                    <h4>Add Songs</h4>
                    <div>${addListHtml}</div>
                `;

                // Delegate add/remove actions
                content.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button[data-action]');
                    if (!btn) return;
                    const action = btn.dataset.action;
                    const fid = btn.dataset.fileId;
                    const pid = btn.dataset.playlistId;
                    try {
                        if (action === 'add') {
                            await fetch(`http://127.0.0.1:8000/playlists/${pid}/songs/${fid}`, { method: 'POST' });
                        } else if (action === 'remove') {
                            await fetch(`http://127.0.0.1:8000/playlists/${pid}/songs/${fid}`, { method: 'DELETE' });
                        }
                        showPlaylistDetails(pid); // refresh details
                        loadPlaylists(); // refresh list
                    } catch (err) {
                        console.error('Failed to modify playlist songs', err);
                    }
                }, { once: true });

                modal.classList.add('active');
                document.getElementById('closePlaylistDetails').onclick = () => modal.classList.remove('active');
                document.getElementById('closePlaylistDetailsModal').onclick = () => modal.classList.remove('active');
            } catch (err) {
                console.error('Failed to load playlist details', err);
            }
        }
        
        function editPlaylist(playlistId) {
            // Implementation for editing playlist
            console.log('Edit playlist:', playlistId);
        }
        
        async function deletePlaylist(playlistId) {
            if (!confirm('Are you sure you want to delete this playlist?')) return;
            try {
                await fetch(`http://127.0.0.1:8000/playlists/${playlistId}`, { method: 'DELETE' });
                loadPlaylists();
            } catch (e) {
                console.error('Failed to delete playlist', e);
            }
        }

        function wireCreatePlaylistModal() {
            const openBtns = [
                document.getElementById('createPlaylistMainBtn'),
                document.getElementById('createPlaylistBtn'),
            ].filter(Boolean);
            const modal = document.getElementById('createPlaylistModal');
            const closeBtn = document.getElementById('closePlaylistModal');
            const cancelBtn = document.getElementById('cancelPlaylist');
            const createBtn = document.getElementById('createPlaylist');

            openBtns.forEach(b => b.addEventListener('click', () => modal.classList.add('active')));
            if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.remove('active'));
            if (cancelBtn) cancelBtn.addEventListener('click', () => modal.classList.remove('active'));
            if (createBtn) createBtn.addEventListener('click', async () => {
                const name = document.getElementById('playlistName').value.trim();
                const description = document.getElementById('playlistDescription').value.trim();
                if (!name) { alert('Please enter a playlist name'); return; }
                try {
                    await fetch('http://127.0.0.1:8000/playlists', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description }),
                    });
                    modal.classList.remove('active');
                    document.getElementById('playlistName').value = '';
                    document.getElementById('playlistDescription').value = '';
                    loadPlaylists();
                } catch (e) {
                    console.error('Failed to create playlist', e);
                }
            });
        }
    </script>
    
    <style>
        .playlists-content {
            padding: 2rem;
        }
        
        .playlists-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }
        
        .playlists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .playlist-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            transition: all var(--transition-normal);
            cursor: pointer;
            position: relative;
        }
        
        .playlist-card:hover {
            background: var(--bg-hover);
            transform: translateY(-4px);
            box-shadow: 0 10px 30px var(--shadow);
        }
        
        .playlist-image {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .playlist-image img {
            width: 100%;
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            object-fit: cover;
        }
        
        .playlist-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .playlist-card:hover .playlist-overlay {
            opacity: 1;
        }
        
        .playlist-play-btn {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-full);
            background: var(--primary);
            border: none;
            color: #000;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .playlist-play-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }
        
        .playlist-info {
            margin-bottom: 1rem;
        }
        
        .playlist-name {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .playlist-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }
        
        .playlist-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .playlist-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .playlist-card:hover .playlist-actions {
            opacity: 1;
        }
        
        .playlist-action-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .playlist-action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--text-muted);
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .empty-state p {
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .playlists-section {
            margin-bottom: 3rem;
        }
        
        .playlists-section h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }
        
        .system-playlist {
            border: 2px solid transparent;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
        }
        
        .system-playlist:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--bg-hover), var(--bg-tertiary));
        }
        
        .system-playlist-icon {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .playlist-type {
            background: var(--primary);
            color: #000;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .system-playlist .playlist-type {
            background: var(--text-primary);
            color: var(--bg-primary);
        }
        
        .playlist-card[data-type="liked"] .playlist-type {
            background: #1ed760;
        }
        
        .playlist-card[data-type="favorites"] .playlist-type {
            background: #ff6b6b;
        }
        
        .playlist-card[data-type="old"] .playlist-type {
            background: #4ecdc4;
        }
        
        .playlist-card[data-type="recent"] .playlist-type {
            background: #45b7d1;
        }
        
        .playlist-card[data-type="chill"] .playlist-type {
            background: #96ceb4;
        }
        
        .playlist-card[data-type="workout"] .playlist-type {
            background: #feca57;
        }
        
        .playlist-card[data-type="party"] .playlist-type {
            background: #ff9ff3;
        }
        
        .playlist-card[data-type="study"] .playlist-type {
            background: #a8e6cf;
        }
        
        .playlist-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
        
        .playlist-plays {
            background: var(--bg-tertiary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.7rem;
        }
        
        .playlist-card:hover .playlist-actions {
            opacity: 1;
        }
        
        .playlist-action-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .playlist-action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .system-playlist .playlist-action-btn:hover {
            background: var(--primary);
            color: #000;
        }
    </style>
</body>
</html>